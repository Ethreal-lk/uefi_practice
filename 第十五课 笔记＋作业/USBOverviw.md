#第十五课  Universal Serial Bus（通用串行总线）


##USB Introduce

###USB的优点
- **速度(Low Speed:1.5Mbps Full Speed:12Mbps High Speed:480Mbps)**

低速设备： 鼠标，键盘；


高速设备： USB3.0




- **总线拓扑体系(最多支持4个Hub层以及127个外设)**

- **即插即用**


- **低功耗**

- **标准接口和外设**

##USB Device Type

-  **USB Mass Storage**

	USB CD-Rom, USB HDD, USB Floppy, USB Flash…

- **USB HID**

	USB Keyboard, USB Mouse…

- **USB Hub**


##USB Host Controller Type
### 控制器

- **UHCI**

	Intel Chipset上的USB 1.1主控制器。

- **OCHI**


	符合USB 1.1规范，一个不仅仅是usb用的主控制器接口标准，下面细分为USB，1394等等。主要是遵循csr(configuration space register)标准。是其他厂商在设计usb host controller时遵循的标准，如via, nec, ali, 包括nvidia等等。


- **EHCI **


	 USB 2.0主控制器。

- **xHCI**

	USB 3.0主控制器。

###两个关键词介绍
- **端点（Endpoint）：**
 
每一个USB设备在主机看来就是一个端点的集合，主机只能通过端点与设备进行通讯，以使用设备的功能。每个端点实际上就是一个一定大小的数据缓冲区，这些端点在设备出厂时就已定义好。在USB系统中每一个端点都有唯一的地址，这是由设备地址和端点号给出的。每个端点都有一定的特性。其中包括传输方式、总线访问频率、带宽、端点号、数据包的最大容量等等。端点必须在设备配置后才能生效（端点0除外）。端点0通常为控制端点，用于设备初始化参数等，端点1、 2等一般用作数据端点，存放主机与设备间往来的数据。

- **管道（Pipe）：**

 
一个USB管道是主机端驱动程序的一个数据缓冲区与一个外设端点的连接，它代表了一种在两者之间移动数据的能力。一旦设备被配置，管道就存在了。管道有两种类型，数据流管道（其中的数据没有USB定义的结构）与消息管道（其中的数据必须有USB定义的结构）。管道只是一个逻辑上的概念。



##USB Transfer Type

- **Control Transfer（控制传输）**

 **特点：**
1. 通常用于配置/命令/状态等情形；
2. 其中的设置操作（setup）和状态操作（status）的数据包具有USB定义的结构因此控制传输只能通过消息管道进行；
3. 支持双向传输
4. 对于高速设备允许数据包最大容量为8、16、32或64 字节对于低速设备只有8字节一种选择；
5. 端点不能指定总线访问的频率和占用总线的时间USB 系统软件会做出限制；
6. 具有数据传输保证在必要时可以重试。

**两个操作阶段：设置和状态**

如果数据没有正确接收，那么设备就会忽略它，而且不返回应答包。

![avatar](/picture3/pic1.png)


- **Isochronous Transfer（同步传输）**


 **特点：**


1. 是一种周期的连续的、传输方式通常用于与时间有密切关系的信息的传输；
2. 数据没有USB 定义的结构（数据流管道）；
3. 单向传输如果一个外设需要双向传输则必须使用另一个端点；
4. 只能用于高速设备数据包的最大容量可以从0 到1023 个字节
5. 具有带宽保证并且保持数据传输的速率恒定（每个同步管道每帧传输一个数据包）；
6. 没有数据重发机制要求具有一定的容错性；
7. 与中断方式一起占用总线的时间不得超过一帧的90%。
***
同步操作不同于其他类型只包含**两个阶段令牌和数据**。因为同步传输不支持重发的能力，所以没有应答阶段。另外它也不支持数据的触发同步与重试。

![avatar](/picture3/pic2.png)

- **Interrupt Transfer（中断传输）**
***

1. 用于非周期的自然发生的数据量很小的信息的传输如键盘鼠标等；
2. 数据没有USB 定义的结构数据流管道；
3. 只有输入这一种传输方式即外设到主机；
4. 对于高速设备允许数据包最大容量为小于或等于64 字节对于低速设备只能小于或等于8 字节；
5. 具有最大服务周期保证即在规定时间内保证有一次数据传输；
6. 与同步方式一起占用总线的时间不得超过一帧的90%
7. 具有数据传输保证在必要时可以重试。

中断操作只有输入这一个方向。

![avatar](/picture3/pic3.png)
	
- **Bulk Transfer（批传输）**
***
1. 用于大量的对时间没有要求的数据传输；
2. 数据没有USB 定义的结构（数据流管道）
3. 单向传输如果一个外设需要双向传输则必须使用另一个端点；
4. 只能用于高速设备允许数据包最大容量为8、16、32或64 字节
5. 没有带宽的保证只要有总线空闲就允许传输数据优先级小于控制传输；
6. 具有数据传输保证在必要时可以重试以保证数据的准确性。


批操作包括令牌、数据、应答三个阶段。对于输入操作，如果设备不能返回数据，那么必须发出NAK 或STALL 包；对于输出，如果设备不能接收数据，也要返回NAK 或STALL。

![avatar](/picture3/pic4.png)

##USB Bus Enumerate
- USB总线枚举是指对USB总线上接入的USB设备进行**识别和寻址**操作。由于USB支持热插拔和即插即用，所以当一个USB设备接入USB或从USB上拆除时，主机必须使用总线枚举的过程来识别和管理必要的设备状态变化。并动态地对它进行配置


- 当一个USB设备接入后，下列事件将会发生：

USB设备所接入的集线器通过一个其状态变化管道上的响应向主机报告该事件。这时USB设备处于连接状态，而连接它的端口则被禁用。

主机通过询问集线器来确定变化的真实性质。


主机现在已经知道了新的设备所接入的端口，于是向该端口发送一个端口激活和复位信号。（reset）


集线器把发往该端口的复位信号保持10ms。当复位信号释放后，被激活的端口和集线器将向USB设备提供100mA电流。现在USB设备就处于加电状态。它的所有寄存器和状态都被重新设置，而且它可以对缺省地址做出响应。


在为该USB设备分配地址之前，利用缺省地址仍然可以访问其缺省管道。主机通过读取该设备的描述符，来确定这一USB设备的缺省管道实际可以使用的最大数据负载尺寸 
*(pakagesize     8, 16 ,32数据 )*


主机为USB设备分配一个唯一的USB地址，然后用这个地址和端点0来建立该USB设备的控制管道。

主机读取设备的每一项配置信息。这个过程可能需要传输若干个帧的数据。

根据配置信息，主机就知道如何来使用这一USB设备，于是主机向设备分配一个配置值，这时设备就处于配置完成状态，并且在这一配置中的所有端点都具有其描述的特征。现在USB设备就可以获得其配置描述符中所描述的额定电流量。从设备的观点来看，它已经为使用做好了准备。



	

##USB platform porting

###USB policy overview

 

###Info passed between USB and CSM

### Example of add USB module to a project



